---
name: Lint Code Base

permissions:
  contents: read

on:
  push:
    branches:
      - "*"
    tags:
      - "*"
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Super-linter
    runs-on: ubuntu-latest

    permissions:
      statuses: write
      pull-requests: write # Required for write report in PR

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Full git history is needed to get a proper list of changed files
          # within `super-linter`
          fetch-depth: 0
          persist-credentials: false # https://docs.zizmor.sh/audits/#artipacked

      - name: Check if linter configs changed
        id: linter-changes
        uses: dorny/paths-filter@v3
        with:
          # Ignored for pull requests ‚Äî compares with PR target branch
          base: ${{ github.event.before }}
          filters: |
            linters:
              - ".editorconfig"
              - ".github/linters/**"
              - ".github/workflows/ci-lint.yml"

      - name: Log scan mode
        env:
          CHANGES: ${{ steps.linter-changes.outputs.linters }}
        run: |
          if [[ "$LINTERS_CHANGED" == "true" ]]; then
            echo "üîç Linter configs changed ‚Äî full codebase scan"
          else
            echo "‚ö° Incremental scan ‚Äî changed files only"
          fi

      - name: Lint Code Base
        uses: super-linter/super-linter/slim@v8
        env:
          # Lint all files if linter configs changed
          VALIDATE_ALL_CODEBASE: ${{ steps.linter-changes.outputs.linters == 'true' }}

          VALIDATE_CPP: false # Incompatible with C; clang-format is preferred
          VALIDATE_BIOME_LINT: false # Avoid conflict: Prettier is preferred
          VALIDATE_BIOME_FORMAT: false # Avoid conflict: Prettier is preferred
          VALIDATE_PYTHON_BLACK: false # Avoid conflict: Ruff is preferred
          VALIDATE_GIT_COMMITLINT: false

          # Don't lint the following files
          FILTER_REGEX_EXCLUDE: "CONTRIBUTORS|tests/[^/]+/.*|benchmark/benchmarks"

          SAVE_SUPER_LINTER_SUMMARY: true # Required for generating linting reports in PR

          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IGNORE_GENERATED_FILES: true

  idris-lint:
    name: Idris linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false # https://docs.zizmor.sh/audits/#artipacked
      - name: Lint the sources
        run: python3 lint/lint.py
        shell: bash

  remark-lint:
    name: remark-lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false # https://docs.zizmor.sh/audits/#artipacked

      - name: Set up Node.js
        uses: actions/setup-node@v6 # zizmor: ignore[cache-poisoning]
        with:
          node-version: "24"
          cache-dependency-path: .github/linters/remark/package-lock.json

      - name: Install Dependencies
        run: npm --prefix .github/linters/remark install

      - name: Run remark-lint
        id: remark
        run: |
          set -o pipefail
          npm -C .github/linters/remark exec -- \
              remark . \
              --rc-path .github/linters/remark/remarkrc.mjs \
              --ignore-path .github/linters/remark/remarkignore \
              --ignore-path-resolve-from cwd \
              --frail \
              --no-color \
              2>&1 | tee remark.log

      - name: Generate report
        if: always()
        shell: bash
        env:
          REMARK_OUTCOME: ${{ steps.remark.outcome }}
        run: |
          # Parse stats from log
          files_checked=$(grep -cE '\.md(: no issues found)?$' remark.log || echo "0")
          files_ok=$(grep -cE ': no issues found$' remark.log || echo "0")
          files_with_issues=$((files_checked - files_ok))
          warn_count=$(grep -oP '^‚ö†[[:space:]]*\K[0-9]+(?= warnings?)' remark.log | tail -n 1 || echo "0")
          warn_count="${warn_count:-0}"

          if [[ "$REMARK_OUTCOME" == "success" ]]; then
            status="Pass ‚úÖ"
          else
            status="Fail ‚ùå"
          fi

          {
            echo "## üìù Remark Lint Summary"
            echo
            echo "| Metric | Count |"
            echo "|--------|------:|"
            echo "| **Status** | $status |"
            echo "| Files checked | $files_checked |"
            echo "| Files with issues | $files_with_issues |"
            echo "| Warnings | $warn_count |"
            echo
            echo "<details>"
            echo "<summary>üìÑ Full output</summary>"
            echo
            echo '```'
            cat remark.log
            echo '```'
            echo "</details>"
          } >> "$GITHUB_STEP_SUMMARY"
