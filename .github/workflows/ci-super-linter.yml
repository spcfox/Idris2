---
name: Lint Code Base

permissions:
  contents: read

on:
  push:
    branches:
      - "*"
    tags:
      - "*"
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Lint Code Base
    runs-on: ubuntu-latest

    permissions:
      statuses: write
      pull-requests: write # Required for write report in PR

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Full git history is needed to get a proper list of changed files
          # within `super-linter`
          fetch-depth: 0
          persist-credentials: false # https://docs.zizmor.sh/audits/#artipacked

      - name: Check if linter configs changed
        id: linter-changes
        uses: dorny/paths-filter@v3
        with:
          # Ignored for pull requests ‚Äî compares with PR target branch
          base: ${{ github.event.before }}
          filters: |
            linters:
              - ".editorconfig"
              - ".github/linters/**"
              - ".github/workflows/ci-super-linter.yml"

      - name: Log scan mode
        env:
          CHANGES: ${{ steps.linter-changes.outputs.linters }}
        run: |
          if [[ "$LINTERS_CHANGED" == "true" ]]; then
            echo "üîç Linter configs changed ‚Äî full codebase scan"
          else
            echo "‚ö° Incremental scan ‚Äî changed files only"
          fi

      - name: Lint Code Base
        uses: super-linter/super-linter/slim@v8
        env:
          # Lint all files if linter configs changed
          VALIDATE_ALL_CODEBASE: ${{ steps.linter-changes.outputs.linters == 'true' }}

          VALIDATE_CPP: false # Incompatible with C; clang-format is preferred
          VALIDATE_BIOME_LINT: false # Avoid conflict: Prettier is preferred
          VALIDATE_BIOME_FORMAT: false # Avoid conflict: Prettier is preferred
          VALIDATE_PYTHON_BLACK: false # Avoid conflict: Ruff is preferred
          VALIDATE_GIT_COMMITLINT: false

          # Don't lint the following files
          FILTER_REGEX_EXCLUDE: "CONTRIBUTORS|tests/[^/]+/.*|benchmark/benchmarks"

          SAVE_SUPER_LINTER_SUMMARY: true # Required for generating linting reports in PR

          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IGNORE_GENERATED_FILES: true
